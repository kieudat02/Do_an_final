<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dashboard</title>
        <!-- Embed Font -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
            rel="stylesheet"
        />
        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Font Awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <!-- CSS -->
        <link rel="stylesheet" href="/css/main.css" />
    </head>
    <body>        
        <div class="dashboard" 
            <% if (message) { %>
                data-success-message="<%= message %>"
            <% } %>
            <% if (error) { %>
                data-error-message="<%= error %>"
            <% } %>
        >
            <div class="container-fluid">
                <div class="dashboard__inner">
                    <%- include('partials/sidebar') %>
                    <!-- Main Content -->
                    <main class="dashboard-main">
                        <!-- Stats Cards -->    
                        <div class="stats-cards">
                            <div class="stats-card">
                                <div class="stats-card__icon">
                                    <i class="fas fa-tag"></i>
                                </div>
                                <div class="stats-card__content">
                                    <h3>Tours</h3>
                                    <div class="stats-card__numbers">
                                        <span class="active">Hoạt động: <%= activeTours %></span>
                                        <span class="inactive">Không hoạt động: <%= inactiveTours %></span>
                                    </div>
                                </div>
                            </div>

                            <div class="stats-card">
                                <div class="stats-card__icon">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <div class="stats-card__content">
                                    <h3>Danh mục</h3>
                                    <div class="stats-card__numbers">
                                        <span class="active">Hoạt động: <%= activeCategories %></span>
                                        <span class="inactive">Không hoạt động: <%= inactiveCategories %></span>
                                    </div>
                                </div>
                            </div>

                            <div class="stats-card">
                                <div class="stats-card__icon">
                                    <i class="fas fa-plane-departure"></i>
                                </div>
                                <div class="stats-card__content">
                                    <h3>Điểm khởi hành</h3>
                                    <div class="stats-card__numbers">
                                        <span class="active">Hoạt động: <%= activeDepartures %></span>
                                        <span class="inactive">Không hoạt động: <%= inactiveDepartures %></span>
                                    </div>
                                </div>
                            </div>

                            <div class="stats-card">
                                <div class="stats-card__icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="stats-card__content">
                                    <h3>Điểm đến</h3>
                                    <div class="stats-card__numbers">
                                        <span class="active">Hoạt động: <%= activeDestinations %></span>
                                        <span class="inactive">Không hoạt động: <%= inactiveDestinations %></span>
                                    </div>
                                </div>
                            </div>

                            <div class="stats-card">
                                <div class="stats-card__icon">
                                    <i class="fas fa-bus"></i>
                                </div>
                                <div class="stats-card__content">
                                    <h3>Phương tiện</h3>
                                    <div class="stats-card__numbers">
                                        <span class="active">Hoạt động: <%= activeTransportations %></span>
                                        <span class="inactive">Không hoạt động: <%= inactiveTransportations %></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Section -->
                        <div class="dashboard-charts">
                            <!-- Revenue Chart -->
                            <div class="chart-container revenue-chart">
                                <div class="chart-tabs">
                                    <button class="chart-tab active" data-type="revenue">Doanh thu</button>
                                    <button class="chart-tab" data-type="orders">Tổng đơn hàng</button>
                                    <button class="chart-tab" data-type="cancellations">Tỉ lệ hủy đơn</button>
                                </div>
                                <div class="chart-content">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>

                            <!-- Order Status Chart -->
                            <div class="chart-container status-chart">
                                <div class="chart-tabs">
                                    <button class="chart-tab active" data-type="orders">Đơn hàng</button>
                                    <button class="chart-tab" data-type="revenue-by-payment">Doanh thu theo phương thức thanh toán</button>
                                </div>
                                <div class="chart-content">
                                    <canvas id="orderStatusChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Top Tours Section -->
                        <div class="top-tours">
                            <div class="tour-tabs">
                                <button class="tour-tab active" data-type="most-booked">Tour được đặt nhiều nhất</button>
                                <button class="tour-tab" data-type="most-revenue">Tour doanh thu nhiều nhất</button>
                                <button class="tour-tab" data-type="most-cancelled">Tour bị hủy nhiều nhất</button>
                            </div>
                            <div class="tour-list">
                                <table class="tour-table">
                                    <thead>
                                        <tr>
                                            <th>Ảnh</th>
                                            <th>Tên Tour</th>
                                            <th>Mã Tour</th>
                                            <th>Giá</th>
                                            <th>Số lượng</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (topBookedTours && topBookedTours.length > 0) { %>
                                            <% topBookedTours.forEach(function(tour) { %>
                                                <tr>
                                                    <td><img src="<%= tour.image || '/images/default-tour.jpg' %>" alt="<%= tour.name || 'Tour' %>" onerror="this.src='/images/default-tour.jpg'"></td>
                                                    <td><%= tour.name || 'N/A' %></td>
                                                    <td><%= tour.code || 'N/A' %></td>
                                                    <td><%= (tour.price || 0).toLocaleString('vi-VN') %> VNĐ</td>
                                                    <td><span class="quantity-badge"><%= tour.quantity || 0 %></span></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="5" class="text-center" style="padding: 2rem; color: #6c757d; font-style: italic;">
                                                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                                                    Chưa có dữ liệu tour được đặt
                                                </td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Dashboard Data -->
        <script id="dashboardData" type="application/json">
            {
                "monthlyRevenue": <%- JSON.stringify(monthlyRevenue) %>,
                "pendingOrders": <%= pendingOrders %>,
                "confirmedOrders": <%= confirmedOrders %>,
                "cancelledOrders": <%= cancelledOrders %>,
                "topBookedTours": <%- JSON.stringify(topBookedTours) %>,
                "activeTours": <%= activeTours %>,
                "inactiveTours": <%= inactiveTours %>,
                "activeCategories": <%= activeCategories %>,
                "inactiveCategories": <%= inactiveCategories %>,
                "activeDepartures": <%= activeDepartures %>,
                "inactiveDepartures": <%= inactiveDepartures %>,
                "activeDestinations": <%= activeDestinations %>,
                "inactiveDestinations": <%= inactiveDestinations %>,
                "activeTransportations": <%= activeTransportations %>,
                "inactiveTransportations": <%= inactiveTransportations %>,
                "revenueByPaymentMethod": <%- JSON.stringify(revenueByPaymentMethod) %>
            }
        </script>

        <!-- Toast Notifications -->
        <script src="/js/toast-auto-hide.js?v=<%= Date.now() %>"></script>

        <!-- Dashboard Charts -->
        <script src="/js/dashboard.js?v=<%= Date.now() %>"></script>

        <!-- Session Security -->
        <script src="/js/session-security.js?v=<%= Date.now() %>"></script>
    </body>
</html>
