<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chỉnh sửa tour</title>
        <!-- Embed Font -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
            rel="stylesheet"
        />
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Font Awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <!-- Select2 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <!-- CSS -->
        <link rel="stylesheet" href="/css/main.css" />
    </head>
    <body>
        <div class="dashboard">
            <div class="container_fuild">
                <div class="dashboard__inner">
                    <%- include('../partials/sidebar') %>
                    <div class="tour">
                        <div class="row justify-content-center">
                            <div class="col-md-12">
                                <div class="tour-form">
                                    <div class="tour-form__header">
                                        <h3>Chỉnh sửa tour</h3>
                                    </div>
                                    
                                    <!-- Notification Messages -->
                                    <% if (typeof message !== 'undefined' && message && message.length > 0) { %>
                                    <div class="modal-notify modal-notify--active modal-notify--success">
                                        <div class="modal-notify__content">
                                            <span class="modal-notify__message">
                                                <i class="fas fa-check-circle me-2"></i><%= message[0] %>
                                            </span>
                                            <button class="modal-notify__close">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <% } %>
                                    
                                    <% if (typeof error !== 'undefined' && error && error.length > 0) { %>
                                    <div class="modal-notify modal-notify--active modal-notify--error">
                                        <div class="modal-notify__content">
                                            <span class="modal-notify__message">
                                                <i class="fas fa-exclamation-circle me-2"></i><%= error[0] %>
                                            </span>
                                            <button class="modal-notify__close">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <% } %>
                                    
                                    <div class="tour-form__body">
                                        <% if (userPermissions && userPermissions.includes('UPDATE_TOUR')) { %>
                                        <form
                                            method="POST"
                                            action="/tour/edit/<%= tour._id %>"
                                            enctype="multipart/form-data"
                                            id="tourForm"
                                        >
                                            <%- include('../partials/csrf-token') %>
                                            <!-- 1. THÔNG TIN CỞ BẢN -->
                                            <div class="form-section mb-5">
                                                <div class="mb-4">
                                                    <label for="title" class="form-label">
                                                        Tiêu đề tour <span class="text-danger">*</span>
                                                    </label>
                                                    <input
                                                        type="text"
                                                        class="form-control"
                                                        id="title"
                                                        name="title"
                                                        placeholder="Nhập tiêu đề tour..."
                                                        value="<%= tour.title %>"
                                                        required
                                                    />
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-4">
                                                            <label for="code" class="form-label">
                                                                Mã tour <span class="text-danger">*</span>
                                                            </label>
                                                            <div class="input-group">
                                                                <input
                                                                    type="text"
                                                                    class="form-control"
                                                                    id="code"
                                                                    name="code"
                                                                    placeholder="Nhập mã tour..."
                                                                    value="<%= tour.code %>"
                                                                    required
                                                                />
                                                                <button 
                                                                    class="btn btn-outline-secondary" 
                                                                    type="button" 
                                                                    id="generateCodeBtn"
                                                                    title="Tạo mã tự động"
                                                                >
                                                                    <i class="fas fa-magic"></i>
                                                                </button>
                                                            </div>
                                                            <div id="codeMessage" class="form-text" style="display: none;"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-4">
                                                            <label for="category" class="form-label">
                                                                Danh mục <span class="text-danger">*</span>
                                                            </label>
                                                            <select class="form-select select2" id="category" name="category" required>
                                                                <option value="">-- Chọn danh mục --</option>
                                                                <% if (categories && categories.length > 0) { %>
                                                                    <% categories.forEach(category => { %>
                                                                        <option value="<%= category._id %>" <%= tour.category && tour.category.toString() === category._id.toString() ? 'selected' : '' %>><%= category.name %></option>
                                                                    <% }); %>
                                                                <% } %>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="mb-4">
                                                            <label for="departure" class="form-label">
                                                                Điểm khởi hành <span class="text-danger">*</span>
                                                            </label>
                                                            <select class="form-select select2" id="departure" name="departure" required>
                                                                <option value="">-- Chọn điểm khởi hành --</option>
                                                                <% if (departures && departures.length > 0) { %>
                                                                    <% departures.forEach(departure => { %>
                                                                        <option value="<%= departure._id %>" <%= tour.departure && tour.departure.toString() === departure._id.toString() ? 'selected' : '' %>><%= departure.name %></option>
                                                                    <% }); %>
                                                                <% } %>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-4">
                                                            <label for="destination" class="form-label">
                                                                Điểm đến <span class="text-danger">*</span>
                                                            </label>
                                                            <select class="form-select select2" id="destination" name="destination" required>
                                                                <option value="">-- Chọn điểm đến --</option>
                                                                <% if (destinations && destinations.length > 0) { %>
                                                                    <% destinations.forEach(destination => { %>
                                                                        <option value="<%= destination._id %>" <%= tour.destination && tour.destination.toString() === destination._id.toString() ? 'selected' : '' %>><%= destination.name %></option>
                                                                    <% }); %>
                                                                <% } %>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-4">
                                                            <label for="transportation" class="form-label">
                                                                Phương tiện <span class="text-danger">*</span>
                                                            </label>
                                                            <select class="form-select select2" id="transportation" name="transportation" required>
                                                                <option value="">-- Chọn phương tiện --</option>
                                                                <% if (transportations && transportations.length > 0) { %>
                                                                    <% transportations.forEach(trans => { %>
                                                                        <option value="<%= trans._id %>" <%= tour.transportation && tour.transportation.toString() === trans._id.toString() ? 'selected' : '' %>><%= trans.title %></option>
                                                                    <% }); %>
                                                                <% } %>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 2. THÔNG TIN BỔ SUNG -->
                                            <div class="form-section mb-5">
                                                <h4 class="section-title mb-4">Thông tin bổ sung</h4>
                                                <div class="itinerary-item border rounded p-3 mb-3">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-4">
                                                                <label for="attractions" class="form-label">
                                                                    Điểm tham quan
                                                                </label>
                                                                <textarea
                                                                    class="form-control"
                                                                    id="attractions"
                                                                    name="attractions"
                                                                    rows="3"
                                                                    placeholder="Nhập các điểm tham quan..."
                                                                ><%= tour.attractions || '' %></textarea>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-4">
                                                                <label for="cuisine" class="form-label">
                                                                    Ẩm thực
                                                                </label>
                                                                <textarea
                                                                    class="form-control"
                                                                    id="cuisine"
                                                                    name="cuisine"
                                                                    rows="3"
                                                                    placeholder="Nhập thông tin ẩm thực..."
                                                                ><%= tour.cuisine || '' %></textarea>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-4">
                                                                <label for="suitableTime" class="form-label">
                                                                    Thời gian thích hợp
                                                                </label>
                                                                <textarea
                                                                    class="form-control"
                                                                    id="suitableTime"
                                                                    name="suitableTime"
                                                                    rows="3"
                                                                    placeholder="Nhập thời gian thích hợp..."
                                                                ><%= tour.suitableTime || '' %></textarea>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-4">
                                                                <label for="suitableObject" class="form-label">
                                                                    Đối tượng thích hợp
                                                                </label>
                                                                <textarea
                                                                    class="form-control"
                                                                    id="suitableObject"
                                                                    name="suitableObject"
                                                                    rows="3"
                                                                    placeholder="Nhập đối tượng thích hợp..."
                                                                ><%= tour.suitableObject || '' %></textarea>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="col-md-6">
                                                            <div class="mb-4">
                                                                <label for="vehicleInfo" class="form-label">
                                                                    Phương tiện
                                                                </label>
                                                                <textarea
                                                                    class="form-control"
                                                                    id="vehicleInfo"
                                                                    name="vehicleInfo"
                                                                    rows="3"
                                                                    placeholder="Ví dụ: Xe 4-16 chỗ, máy lạnh..."
                                                                ><%= tour.vehicleInfo || '' %></textarea>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-4">
                                                                <label class="form-label">Ưu đãi</label>
                                                                <div id="promotionContainer">
                                                                    <% if (tour.promotions && tour.promotions.length > 0) { %>
                                                                        <% for (let i = 0; i < Math.ceil(tour.promotions.length / 2); i++) { %>
                                                                            <div class="row mb-2">
                                                                                <div class="col-md-6">
                                                                                    <input type="text" class="form-control" name="promotions[<%= i * 2 %>][label]"
                                                                                           placeholder="Ưu đãi <%= i * 2 + 1 %>" value="<%= tour.promotions[i * 2] ? tour.promotions[i * 2].label || '' : '' %>" />
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <% if (tour.promotions[i * 2 + 1]) { %>
                                                                                        <input type="text" class="form-control" name="promotions[<%= i * 2 + 1 %>][label]"
                                                                                               placeholder="Ưu đãi <%= i * 2 + 2 %>" value="<%= tour.promotions[i * 2 + 1].label || '' %>" />
                                                                                    <% } else { %>
                                                                                        <input type="text" class="form-control" name="promotions[<%= i * 2 + 1 %>][label]"
                                                                                               placeholder="Ưu đãi <%= i * 2 + 2 %>" />
                                                                                    <% } %>
                                                                                </div>
                                                                            </div>
                                                                        <% } %>
                                                                    <% } else { %>
                                                                        <div class="row mb-2">
                                                                            <div class="col-md-6">
                                                                                <input type="text" class="form-control" name="promotions[0][label]"
                                                                                       placeholder="Khuyến mãi 50%" />
                                                                            </div>
                                                                            <div class="col-md-6">
                                                                                <input type="text" class="form-control" name="promotions[1][label]"
                                                                                       placeholder="Ưu đãi thứ 2" />
                                                                            </div>
                                                                        </div>
                                                                        <div class="row mb-2">
                                                                            <div class="col-md-6">
                                                                                <input type="text" class="form-control" name="promotions[2][label]"
                                                                                       placeholder="Ưu đãi thứ 3" />
                                                                            </div>
                                                                            <div class="col-md-6">
                                                                                <input type="text" class="form-control" name="promotions[3][label]"
                                                                                       placeholder="Ưu đãi thứ 4" />
                                                                            </div>
                                                                        </div>
                                                                    <% } %>
                                                                </div>
                                                                <button type="button" class="btn btn-outline-primary btn-sm"
                                                                        onclick="addPromotionRow()">
                                                                    <i class="fas fa-plus"></i> Thêm ưu đãi
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 4. LỊCH TRÌNH TOUR -->
                                            <div class="form-section mb-5">
                                                <h4 class="section-title d-flex justify-content-between">
                                                    Lịch trình tour
                                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2 mb-3" onclick="addItinerary()">
                                                        <i class="fas fa-plus me-1"></i>Thêm lịch trình
                                                    </button>
                                                </h4>
                                                
                                                <div id="itineraryContainer">
                                                    <% if (tour.itinerary && tour.itinerary.length > 0) { %>
                                                        <% tour.itinerary.forEach((item, index) => { %>
                                                            <div class="itinerary-item border rounded p-3 mb-3 position-relative">
                                                                <% if (tour.itinerary.length > 1) { %>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger itinerary-delete-btn" onclick="removeItinerary(this)" style="position: absolute; top: 10px; right: 10px; width: 24px; height: 23px; border: 1px solid #dc3545; padding: 0; border-radius: 6px;">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                <% } else { %>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger itinerary-delete-btn" onclick="removeItinerary(this)" style="position: absolute; top: 10px; right: 10px; width: 24px; height: 23px; border: 1px solid #dc3545; padding: 0; border-radius: 6px; display: none;">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                <% } %>
                                                                
                                                                <div class="row">
                                                                    <div class="col-md-3">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Ngày <span class="text-danger">*</span></label>
                                                                            <input type="number" class="form-control" name="itinerary[<%= index %>][day]" value="<%= item.day %>" min="1" required disabled>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-9">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                                                                            <input type="text" class="form-control" name="itinerary[<%= index %>][title]" value="<%= item.title %>" placeholder="Ví dụ: Khởi hành từ Hà Nội" required>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Thông tin chi tiết <span class="text-danger">*</span></label>
                                                                    <textarea class="form-control ckeditor-itinerary" name="itinerary[<%= index %>][details]" rows="4" placeholder="Nhập thông tin chi tiết cho ngày này: địa điểm tham quan, hoạt động, bữa ăn..." required><%= item.details %></textarea>
                                                                </div>

                                                                <div class="mb-3">
                                                                    <label class="form-label">Ngày bắt đầu</label>
                                                                    <input type="date" class="form-control" name="itinerary[<%= index %>][dayStart]"
                                                                           value="<%= item.dayStart ? new Date(item.dayStart).toISOString().split('T')[0] : '' %>" />
                                                                </div>
                                                            </div>
                                                        <% }); %>
                                                    <% } else { %>
                                                        <div class="itinerary-item border rounded p-3 mb-3 position-relative">
                                                            <button type="button" class="btn btn-sm btn-outline-danger itinerary-delete-btn" onclick="removeItinerary(this)" style="position: absolute; top: 10px; right: 10px; display: none; width: 24px; height: 23px; border: 1px solid #dc3545; padding: 0; border-radius: 6px;">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                            
                                                            <div class="row">
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Ngày <span class="text-danger">*</span></label>
                                                                        <input type="number" class="form-control" name="itinerary[0][day]" value="1" min="1" required disabled>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-9">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                                                                        <input type="text" class="form-control" name="itinerary[0][title]" placeholder="Ví dụ: Khởi hành từ Hà Nội" required>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Thông tin chi tiết <span class="text-danger">*</span></label>
                                                                <textarea class="form-control ckeditor-itinerary" name="itinerary[0][details]" rows="4" placeholder="Nhập thông tin chi tiết cho ngày này: địa điểm tham quan, hoạt động, bữa ăn..." required></textarea>
                                                            </div>

                                                        </div>
                                                    <% } %>
                                                </div>
                                            </div>

                                            <!-- OVERVIEW -->
                                            <div class="form-section mb-5">
                                                <h4 class="section-title mb-4">Tổng quan tour</h4>
                                                <div class="itinerary-item border rounded p-3 mb-3">
                                                    <div class="mb-4">
                                                        <label for="overview_introHtml" class="form-label">Giới thiệu</label>
                                                        <textarea class="form-control ckeditor-overview" id="overview_introHtml" name="overview_introHtml"
                                                                  rows="4" placeholder="Nhập nội dung giới thiệu tour: điểm nổi bật, trải nghiệm đặc biệt..."><%= tour.overview?.introHtml || '' %></textarea>
                                                    </div>

                                                    <!-- Pricing Section -->
                                                    <div class="mb-4">
                                                        <div class="mb-3">
                                                            <label for="pricing_yearTitle" class="form-label">Tiêu đề lịch khởi hành</label>
                                                            <input type="text" class="form-control" id="pricing_yearTitle" name="pricing_yearTitle"
                                                                   placeholder="LỊCH KHỞI HÀNH 2024" value="<%= tour.overview?.pricing?.yearTitle || '' %>" />
                                                        </div>

                                                        <div class="mb-3">
                                                            <label class="form-label">Lịch giá</label>
                                                            <div id="pricingRowsContainer">
                                                                <% if (tour.overview?.pricing?.rows && tour.overview.pricing.rows.length > 0) { %>
                                                                    <% tour.overview.pricing.rows.forEach(function(row, index) { %>
                                                                        <div class="row mb-2 pricing-row" data-index="<%= index %>">
                                                                            <div class="col-md-5">
                                                                                <input type="text" class="form-control pricing-date-input"
                                                                                       name="pricing_dateLabel[<%= index %>]"
                                                                                       placeholder="Ngày khởi hành"
                                                                                       value="<%= row.dateLabel || '' %>"
                                                                                       data-index="<%= index %>" />
                                                                            </div>
                                                                            <div class="col-md-5">
                                                                                <input type="text" class="form-control pricing-price-input"
                                                                                       name="pricing_priceText[<%= index %>]"
                                                                                       placeholder="Giá tour"
                                                                                       value="<%= row.priceText || '' %>"
                                                                                       data-index="<%= index %>" />
                                                                            </div>
                                                                            <div class="col-md-2">
                                                                                <button type="button" class="btn btn-outline-danger btn-sm"
                                                                                        onclick="removePricingRow(this)">
                                                                                    <i class="fas fa-trash"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    <% }); %>
                                                                <% } else { %>
                                                                    <div class="row mb-2 pricing-row" data-index="0">
                                                                        <div class="col-md-5">
                                                                            <input type="text" class="form-control pricing-date-input"
                                                                                   name="pricing_dateLabel[0]"
                                                                                   placeholder="Ngày khởi hành"
                                                                                   data-index="0" />
                                                                        </div>
                                                                        <div class="col-md-5">
                                                                            <input type="text" class="form-control pricing-price-input"
                                                                                   name="pricing_priceText[0]"
                                                                                   placeholder="Giá tour"
                                                                                   data-index="0" />
                                                                        </div>
                                                                        <div class="col-md-2">
                                                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                                                    onclick="removePricingRow(this)">
                                                                                <i class="fas fa-trash"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                <% } %>
                                                            </div>
                                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                                    onclick="addPricingRow()">
                                                                <i class="fas fa-plus"></i> Thêm lịch giá
                                                            </button>
                                                        </div>

                                                        <div class="mb-3">
                                                            <label for="pricing_noteHtml" class="form-label">Ghi chú giá</label>
                                                            <textarea class="form-control" id="pricing_noteHtml" name="pricing_noteHtml"
                                                                      rows="2" placeholder="Ghi chú về giá tour..."><%= tour.overview?.pricing?.noteHtml || '' %></textarea>
                                                        </div>
                                                    </div>

                                                    <!-- Promotions Section -->
                                                    <div class="mb-4">
                                                        <h5>Khuyến mãi</h5>
                                                        <div id="promotionsContainer">
                                                            <% if (tour.overview?.promotions && tour.overview.promotions.length > 0) { %>
                                                                <% tour.overview.promotions.forEach(function(promo, index) { %>
                                                                    <div class="row mb-2">
                                                                        <div class="col-md-4">
                                                                            <input type="text" class="form-control" name="promo_label[]"
                                                                                   placeholder="Nhãn khuyến mãi" value="<%= promo.label || '' %>" />
                                                                        </div>
                                                                        <div class="col-md-6">
                                                                            <input type="text" class="form-control" name="promo_desc[]"
                                                                                   placeholder="Mô tả khuyến mãi" value="<%= promo.desc || '' %>" />
                                                                        </div>
                                                                        <div class="col-md-2">
                                                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                                                    onclick="removePromotion(this)">
                                                                                <i class="fas fa-trash"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                <% }); %>
                                                            <% } else { %>
                                                                <div class="row mb-2">
                                                                    <div class="col-md-4">
                                                                        <input type="text" class="form-control" name="promo_label[]"
                                                                               placeholder="Nhãn khuyến mãi" />
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <input type="text" class="form-control" name="promo_desc[]"
                                                                               placeholder="Mô tả khuyến mãi" />
                                                                    </div>
                                                                    <div class="col-md-2">
                                                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                                                onclick="removePromotion(this)">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            <% } %>
                                                        </div>
                                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                                onclick="addPromotion()">
                                                            <i class="fas fa-plus"></i> Thêm khuyến mãi
                                                        </button>
                                                    </div>

                                                    <!-- Description Section -->
                                                    <div class="mb-4">
                                                        <label for="overview_description" class="form-label">Mô tả tour</label>
                                                        <textarea class="form-control ckeditor-overview" id="overview_description" name="overview_description"
                                                                  rows="5" placeholder="Nhập mô tả chi tiết về tour, lịch trình tổng quan, điểm đến..."><%= tour.overview?.description || '' %></textarea>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- CHI TIẾT TOUR -->
                                            <div class="form-section mb-5">
                                                <h4 class="section-title d-flex justify-content-between">
                                                    Chi tiết tour
                                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2 mb-3" onclick="addPriceBlock()">
                                                        <i class="fas fa-plus me-1"></i>Thêm tour chi tiết
                                                    </button>
                                                </h4>
                                                
                                                <div id="priceContainer">
                                                    <% if (tourDetails && tourDetails.length > 0) { %>
                                                        <% tourDetails.forEach((detail, index) => { %>
                                                            <div class="price-block border rounded p-4 mb-4">
                                                                <div class="price-block-header">
                                                                    <h5 class="price-block-title">Tour chi tiết <%= index + 1 %></h5>
                                                                    <% if (tourDetails.length > 1) { %>
                                                                        <button type="button" class="btn btn-sm btn-outline-danger price-block-delete" onclick="removePriceBlock(this)">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    <% } else { %>
                                                                        <button type="button" class="btn btn-sm btn-outline-danger price-block-delete" onclick="removePriceBlock(this)" style="opacity: 0; visibility: hidden;">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    <% } %>
                                                                </div>
                                                                
                                                                <div class="row">
                                                                    <div class="col-md-3">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Giá người lớn <span class="text-danger">*</span></label>
                                                                            <input type="number" class="form-control" name="tourDetails[<%= index %>][adultPrice]" value="<%= detail.adultPrice %>" placeholder="0" required min="0">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Giá trẻ em</label>
                                                                            <input type="number" class="form-control" name="tourDetails[<%= index %>][childrenPrice]" value="<%= detail.childrenPrice %>" placeholder="0" min="0">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Giá trẻ nhỏ</label>
                                                                            <input type="number" class="form-control" name="tourDetails[<%= index %>][childPrice]" value="<%= detail.childPrice %>" placeholder="0" min="0">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Giá trẻ sơ sinh</label>
                                                                            <input type="number" class="form-control" name="tourDetails[<%= index %>][babyPrice]" value="<%= detail.babyPrice %>" placeholder="0" min="0">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="row">
                                                                    <div class="col-md-3">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Phụ thu phòng đơn</label>
                                                                            <input type="number" class="form-control" name="tourDetails[<%= index %>][singleRoomSupplementPrice]" value="<%= detail.singleRoomSupplementPrice %>" placeholder="0" min="0">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Giảm giá (%)</label>
                                                                            <input type="number" class="form-control" name="tourDetails[<%= index %>][discount]" value="<%= detail.discount %>" placeholder="0" min="0" max="100">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Stock <span class="text-danger">*</span></label>
                                                                            <input type="number" class="form-control" name="tourDetails[<%= index %>][stock]" value="<%= detail.stock %>" placeholder="0" required min="0">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="row">
                                                                    <div class="col-md-6">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Ngày khởi hành <span class="text-danger">*</span></label>
                                                                            <input type="date" class="form-control" name="tourDetails[<%= index %>][dayStart]" value="<%= new Date(detail.dayStart).toISOString().split('T')[0] %>" required>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Ngày trở lại <span class="text-danger">*</span></label>
                                                                            <input type="date" class="form-control" name="tourDetails[<%= index %>][dayReturn]" value="<%= new Date(detail.dayReturn).toISOString().split('T')[0] %>" required>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        <% }); %>
                                                    <% } else { %>
                                                        <div class="price-block border rounded p-4 mb-4">
                                                            <div class="price-block-header">
                                                                <h5 class="price-block-title">Tour chi tiết 1</h5>
                                                                <button type="button" class="btn btn-sm btn-outline-danger price-block-delete" onclick="removePriceBlock(this)" style="opacity: 0; visibility: hidden;">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                            
                                                            <div class="row">
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Giá người lớn <span class="text-danger">*</span></label>
                                                                        <input type="number" class="form-control" name="tourDetails[0][adultPrice]" placeholder="0" required min="0">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Giá trẻ em</label>
                                                                        <input type="number" class="form-control" name="tourDetails[0][childrenPrice]" placeholder="0" min="0">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Giá trẻ nhỏ</label>
                                                                        <input type="number" class="form-control" name="tourDetails[0][childPrice]" placeholder="0" min="0">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Giá trẻ sơ sinh</label>
                                                                        <input type="number" class="form-control" name="tourDetails[0][babyPrice]" placeholder="0" min="0">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row">
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Phụ thu phòng đơn</label>
                                                                        <input type="number" class="form-control" name="tourDetails[0][singleRoomSupplementPrice]" placeholder="0" min="0">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Giảm giá (%)</label>
                                                                        <input type="number" class="form-control" name="tourDetails[0][discount]" placeholder="0" min="0" max="100">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Stock <span class="text-danger">*</span></label>
                                                                        <input type="number" class="form-control" name="tourDetails[0][stock]" placeholder="0" required min="0">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Ngày khởi hành <span class="text-danger">*</span></label>
                                                                        <input type="date" class="form-control" name="tourDetails[0][dayStart]" required min="<%= new Date().toISOString().split('T')[0] %>">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Ngày trở lại <span class="text-danger">*</span></label>
                                                                        <input type="date" class="form-control" name="tourDetails[0][dayReturn]" required min="<%= new Date().toISOString().split('T')[0] %>">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    <% } %>
                                                </div>
                                            </div>

                                            <!-- BAO GỒM & ĐIỀU KHOẢN -->
                                            <div class="form-section mb-5">
                                                <h4 class="section-title mb-4">Bao gồm & Điều khoản</h4>
                                                <div class="itinerary-item border rounded p-3 mb-3">
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="mb-4">
                                                                <label for="includes_included" class="form-label">Bao gồm</label>
                                                                <textarea class="form-control ckeditor-includes" id="includes_included" name="includes_included"
                                                                          rows="5" placeholder="Vé máy bay khứ hồi, khách sạn 4 sao, bữa ăn theo chương trình, hướng dẫn viên..."><%= tour.includes?.included ? tour.includes.included.join('\n') : '' %></textarea>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-4">
                                                                <label for="includes_excluded" class="form-label">Không bao gồm</label>
                                                                <textarea class="form-control ckeditor-includes" id="includes_excluded" name="includes_excluded"
                                                                          rows="5" placeholder="Chi phí cá nhân, tip, bảo hiểm..."><%= tour.includes?.excluded ? tour.includes.excluded.join('\n') : '' %></textarea>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-4">
                                                                <label for="notes_important" class="form-label">Lưu ý</label>
                                                                <textarea class="form-control ckeditor-includes" id="notes_important" name="notes_important"
                                                                          rows="5" placeholder="Mang theo CMND/Passport, kiểm tra thời tiết..."><%= tour.includes?.notes?.important ? tour.includes.notes.important.join('\n') : '' %></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- ĐIỂM NỔI BẬT -->
                                            <div class="form-section mb-5">
                                                <h4 class="section-title mb-4">Điểm nổi bật</h4>
                                                <div class="itinerary-item border rounded p-3 mb-3">
                                                    <div class="mb-4">
                                                        <label for="highlights" class="form-label">Điểm nổi bật</label>
                                                        <textarea class="form-control ckeditor-highlights" id="highlights" name="highlights"
                                                                  rows="5" placeholder="Các điểm nổi bật, trải nghiệm độc đáo của tour..."><%= tour.highlights ? tour.highlights.join('\n') : '' %></textarea>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- HÌNH ẢNH TOUR -->
                                            <div class="form-section mb-5">
                                                <h4 class="section-title mb-4">
                                                    Hình ảnh
                                                </h4>
                                                <div class="itinerary-item border rounded p-3 mb-3">
                                                    <div class="mb-4">
                                                        <label for="images" class="form-label">
                                                            Ảnh tour
                                                        </label>
                                                        <input
                                                            type="file"
                                                            class="form-control"
                                                            id="images"
                                                            name="images"
                                                            accept="image/*"
                                                            multiple
                                                        />
                                                        <div class="form-text mt-2" style="font-style: italic;">
                                                            Chọn nhiều file ảnh (JPG, PNG, GIF). Kích thước tối đa mỗi file: 5MB                                                         
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Hiển thị ảnh hiện tại -->
                                                    <% if (tour.images && tour.images.length > 0) { %>
                                                        <div class="existing-images mb-4">
                                                            <label class="form-label">
                                                                <i class="fas fa-images me-2"></i>Ảnh hiện tại:
                                                            </label>
                                                            <div class="row g-2">
                                                                <% tour.images.forEach((image, index) => { %>
                                                                    <div class="col-md-3">
                                                                        <div class="image-preview-item border rounded overflow-hidden">
                                                                            <img src="<%= image %>" alt="Tour image <%= index + 1 %>" class="img-fluid w-100" style="height: 150px; object-fit: cover; cursor: pointer;" onclick="showImageModal('<%= image %>', 'Tour image <%= index + 1 %>')">
                                                                        </div>
                                                                    </div>
                                                                <% }); %>
                                                            </div>
                                                        </div>
                                                    <% } %>
                                                    
                                                    <div class="images-preview" id="imagesPreview" style="display: none;">
                                                        <label class="form-label">
                                                            <i class="fas fa-images me-2"></i>Các ảnh đã chọn:
                                                        </label>
                                                        <div class="preview-container row g-2" id="previewContainer">
                                                            <!-- Preview images will be added here -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="d-flex justify-content-between gap-3 py-3">
                                                <a href="/tour" class="btn btn-secondary">
                                                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                                                </a>
                                                <div class="d-flex align-items-center">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-save me-2"></i>Cập nhật tour
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                        <% } else { %>
                                            <div class="alert alert-warning" role="alert">
                                                Bạn không có quyền chỉnh sửa tour này.
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Modal -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">Xem ảnh</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="modalImage" src="" alt="" class="img-fluid">
                    </div>
                </div>
            </div>
        </div>

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- Select2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/js/toast-auto-hide.js?v=<%= Date.now() %>"></script>
        <script src="/js/tour.js?v=<%= Date.now() %>"></script>
        <script src="/js/selectEdit.js?v=<%= Date.now() %>"></script>
        


        <!-- CKEditor 5 Integration -->
        <script src="/vendor/ckeditor/ckeditor.js"></script>
        <script src="/vendor/ckeditor/translations/vi.js"></script>










    </body>
</html>
